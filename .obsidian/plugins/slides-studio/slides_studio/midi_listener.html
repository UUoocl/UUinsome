<!DOCTYPE html>
<html>
<head>
    <title>MIDI Listener</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1e1e1e; color: #d4d4d4; padding: 20px; margin: 0; }
        #container { max-width: 800px; margin: 0 auto; }
        h1 { color: #569cd6; border-bottom: 1px solid #333; padding-bottom: 10px; }
        #status { margin-bottom: 20px; font-weight: bold; }
        #controls { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }
        button:hover { background: #1177bb; }
        button:disabled { background: #444; cursor: not-allowed; opacity: 0.6; }
        
        #messages { 
            background: #252526; 
            border: 1px solid #444; 
            border-radius: 4px;
            padding: 10px; 
            height: 60vh; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column-reverse;
        }
        .msg { 
            margin-bottom: 8px; 
            border-bottom: 1px solid #333; 
            padding: 8px;
            animation: fadeIn 0.3s ease-out;
        }
        .meta { color: #888; font-size: 0.85em; margin-bottom: 4px; }
        .type { color: #ce9178; font-weight: bold; }
        .details { color: #b5cea8; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .error-hint { color: #f44747; font-size: 0.9em; margin-left: 10px; }
    </style>
</head>
<body>
    <div id="container">
        <h1 id="title">MIDI Listener</h1>
        <div id="status">Connecting...</div>
        
        <div id="controls">
            <button id="noteOnBtn">Send Note On (C3, ch1)</button>
            <button id="noteOffBtn">Send Note Off (C3, ch1)</button>
            <button id="ccBtn">Send CC (Ctrl 1, Val 127, ch1)</button>
            <span id="hint" class="error-hint"></span>
        </div>

        <div id="messages"></div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const targetDevice = urlParams.get('deviceName');
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const titleEl = document.getElementById('title');
        const hintEl = document.getElementById('hint');

        const buttons = {
            noteOn: document.getElementById('noteOnBtn'),
            noteOff: document.getElementById('noteOffBtn'),
            cc: document.getElementById('ccBtn')
        };

        if (targetDevice) {
            titleEl.textContent = `MIDI Listener: ${targetDevice}`;
        } else {
            titleEl.textContent = `MIDI Listener: (All Devices)`;
            Object.values(buttons).forEach(btn => btn.disabled = true);
            hintEl.textContent = "Specify ?deviceName=... in URL to enable sending";
        }

        async function sendMidi(payload) {
            if (!targetDevice) return;
            try {
                const resp = await fetch('/api/midi/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        deviceName: targetDevice,
                        message: payload
                    })
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    alert('Error sending MIDI: ' + (err.error || resp.statusText));
                }
            } catch (e) {
                console.error('Fetch error:', e);
                alert('Failed to send request to server');
            }
        }

        buttons.noteOn.onclick = () => sendMidi({ type: 'noteon', note: 60, velocity: 0.8, channel: 1 });
        buttons.noteOff.onclick = () => sendMidi({ type: 'noteoff', note: 60, channel: 1 });
        buttons.cc.onclick = () => sendMidi({ type: 'controlchange', controller: 1, value: 127, channel: 1 });

        // --- SSE Connection ---
        const eventSource = new EventSource('/api/midi/events');

        eventSource.onopen = () => {
            statusEl.textContent = 'Status: Connected';
            statusEl.style.color = '#4ec9b0';
        };

        eventSource.onerror = (err) => {
            console.error('SSE Error:', err);
            statusEl.textContent = 'Status: Connection Error / Reconnecting...';
            statusEl.style.color = '#f44747';
        };

        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (!targetDevice || data.deviceName === targetDevice) {
                    addMessage(data);
                }
            } catch (e) {
                console.error('Error parsing event data:', e);
            }
        };

        function addMessage(data) {
            const div = document.createElement('div');
            div.className = 'msg';
            
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = `${new Date().toLocaleTimeString()} - Device: ${data.deviceName}`;
            
            const content = document.createElement('div');
            const msg = data.message;
            
            const typeSpan = document.createElement('span');
            typeSpan.className = 'type';
            typeSpan.textContent = msg.type.toUpperCase();
            
            const detailsSpan = document.createElement('span');
            detailsSpan.className = 'details';
            
            let details = ` (Ch: ${msg.channel})`;
            if (msg.note !== null && msg.note !== undefined) details += ` Note: ${msg.note}, Vel: ${msg.velocity}`;
            if (msg.controller !== null && msg.controller !== undefined) details += ` CC: ${msg.controller}, Val: ${msg.value}`;
            
            detailsSpan.textContent = details;
            
            content.appendChild(typeSpan);
            content.appendChild(detailsSpan);
            
            div.appendChild(meta);
            div.appendChild(content);
            
            messagesEl.appendChild(div);
            
            while (messagesEl.children.length > 100) {
                messagesEl.removeChild(messagesEl.firstChild);
            }
        }
    </script>
</body>
</html>
