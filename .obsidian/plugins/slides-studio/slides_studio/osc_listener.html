<!DOCTYPE html>
<html>
<head>
    <title>OSC Listener</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1e1e1e; color: #d4d4d4; padding: 20px; margin: 0; }
        #container { max-width: 800px; margin: 0 auto; }
        h1 { color: #569cd6; border-bottom: 1px solid #333; padding-bottom: 10px; }
        #status { margin-bottom: 20px; font-weight: bold; }
        #controls { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }
        button:hover { background: #1177bb; }
        button:disabled { background: #444; cursor: not-allowed; opacity: 0.6; }
        button.on { background: #4ec9b0; color: #1e1e1e; }
        
        #messages { 
            background: #252526; 
            border: 1px solid #444; 
            border-radius: 4px;
            padding: 10px; 
            height: 60vh; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column-reverse;
        }
        .msg { 
            margin-bottom: 8px; 
            border-bottom: 1px solid #333; 
            padding: 8px;
            animation: fadeIn 0.3s ease-out;
        }
        .meta { color: #888; font-size: 0.85em; margin-bottom: 4px; }
        .address { color: #ce9178; font-weight: bold; }
        .args { color: #b5cea8; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .error-hint { color: #f44747; font-size: 0.9em; margin-left: 10px; }
    </style>
</head>
<body>
    <div id="container">
        <h1 id="title">OSC Listener</h1>
        <div id="status">Connecting...</div>
        
        <div id="controls">
            <button id="toggleBtn">Toggle OSC (/4/toggle1)</button>
            <span id="hint" class="error-hint"></span>
        </div>

        <div id="messages"></div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const targetDevice = urlParams.get('deviceName');
        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const titleEl = document.getElementById('title');
        const toggleBtn = document.getElementById('toggleBtn');
        const hintEl = document.getElementById('hint');

        let isOn = false;

        if (targetDevice) {
            titleEl.textContent = `OSC Listener: ${targetDevice}`;
        } else {
            titleEl.textContent = `OSC Listener: (All Devices)`;
            toggleBtn.disabled = true;
            hintEl.textContent = "Specify ?deviceName=... in URL to enable sending";
        }

        // --- Toggle Logic ---
        toggleBtn.onclick = async () => {
            if (!targetDevice) return;
            
            const nextState = !isOn;
            const val = nextState ? 1 : 0;
            
            try {
                const resp = await fetch('/api/osc/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        deviceName: targetDevice,
                        address: '/4/toggle1',
                        args: [val]
                    })
                });
                
                if (resp.ok) {
                    isOn = nextState;
                    toggleBtn.classList.toggle('on', isOn);
                    toggleBtn.textContent = `Toggle OSC: ${isOn ? 'ON' : 'OFF'}`;
                } else {
                    const err = await resp.json();
                    alert('Error sending OSC: ' + (err.error || resp.statusText));
                }
            } catch (e) {
                console.error('Fetch error:', e);
                alert('Failed to send request to server');
            }
        };

        // --- SSE Connection ---
        const eventSource = new EventSource('/api/osc/events');

        eventSource.onopen = () => {
            statusEl.textContent = 'Status: Connected';
            statusEl.style.color = '#4ec9b0';
        };

        eventSource.onerror = (err) => {
            console.error('SSE Error:', err);
            statusEl.textContent = 'Status: Connection Error / Reconnecting...';
            statusEl.style.color = '#f44747';
        };

        eventSource.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (!targetDevice || data.deviceName === targetDevice) {
                    addMessage(data);
                }
            } catch (e) {
                console.error('Error parsing event data:', e);
            }
        };

        function addMessage(data) {
            const div = document.createElement('div');
            div.className = 'msg';
            
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = `${new Date().toLocaleTimeString()} - Device: ${data.deviceName}`;
            
            const content = document.createElement('div');
            const [address, ...args] = data.message;
            
            const addrSpan = document.createElement('span');
            addrSpan.className = 'address';
            addrSpan.textContent = address;
            
            const argsSpan = document.createElement('span');
            argsSpan.className = 'args';
            argsSpan.textContent = args.length > 0 ? ' ' + JSON.stringify(args) : '';
            
            content.appendChild(addrSpan);
            content.appendChild(argsSpan);
            
            div.appendChild(meta);
            div.appendChild(content);
            
            messagesEl.appendChild(div);
            
            while (messagesEl.children.length > 100) {
                messagesEl.removeChild(messagesEl.firstChild);
            }
        }
    </script>
</body>
</html>