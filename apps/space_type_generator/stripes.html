<!DOCTYPE html>
<html>
  <head>

    <meta charset="UTF-8" />
    <title>STG _v.stripes</title>

    <script src="../lib/p5.min.js"></script>

    <link rel="stylesheet" type="text/css" href="./css/stgStyle.css" />

    <script src="./js/sketch_stripes.js" type="text/javascript"></script>
    <script src="./js/keyboardEngine_190221.js" type="text/javascript"></script>

    <style>
      body {
        padding: 0;
        margin: 0;
      }

      canvas {
        vertical-align: top;
      }

      #ui-layer {
        position: absolute; top: 0; left: 200px; right: 0; height: 40px;
        background: #33333301; border-bottom: 1px solid #444;
        display: flex; align-items: center; padding: 0 10px; gap: 10px; z-index: 0;
      }

      /* button, input, select {
        background: #444; color: white; border: 1px solid #555; padding: 4px 8px; cursor: pointer; border-radius: 3px;
      }
      button:hover { background: #555; } */
    </style>
  </head>

  <body>
    <div id="ui-layer">
    <span>Settings Name</span>
    <input type="text" id="settingsName" placeholder="My Stripe Settings" value="stripe_settings">
    <button onclick="saveSettings()">Save</button>
    <select id="loadSelect"><option>Loading...</option></select>
    <button onclick="loadSettings()">Load</button>
    </div>


    <div class="bottom">
      <h1>SPACE TYPE GENERATOR</h1>
      <h2>_v. Stripes</h2>
      <textarea id="textfield" autofocus="">
SPACE TYPE GENERATOR _V.STRIPES</textarea
      >
      <!-- <textarea id="textfield" autofocus> NO JUSTICE. NO PEACE. </textarea> -->

      <div class="slug">
        <p>
          a kinetic type generator from <a href="http://www.kielm.com">kielm</a
          ><br /><br />
          <a href="https://www.buymeacoffee.com/kieldm">Buy me a coffee</a> to
          help support STG<br />
        </p>
        <button onclick="myFunction()">ReadMe</button>
        </div>
      </div>

    <div class="dropdown">
      <button class="dropbtn">Select...</button>
      <div class="dropdown-content">
        <a href="./cylinder.html">CYLINDER</a>
        <a href="./field.html">FIELD</a>
        <a href="./stripes.html">STRIPES</a>
        <a href="./coil.html">COIL</a>
        <a href="./flag.html">FLAG</a>
        <a href="./morisawa.html">MORISAWA</a>
        <a href="./cascade.html">CASCADE</a>
        <a href="./ribbon.html">RIBBON</a>
        <a href="./layers.html">LAYERS</a>
        <a href="./danger.html">DANGER</a>
        <a href="./string.html">STRING</a>
        <a href="./badge.html">BADGE</a>
        <a href="./clutter.html">CLUTTER</a>
        <a href="./construct.html">CONSTRUCT</a>
        <a href="./snap.html">SNAP</a>
        <a href="./flash.html">FLASH</a>
        <a href="./pow.html">POW</a>
        <a href="./crash.html">CRASH</a>
        <a href="./crashclock.html">CRASH CLOCK</a>
        <a href="./vessel.html">VESSEL</a>
        <a href="./shine.html">SHINE</a>
        <a href="./boost.html">BOOST</a>
      </div>
    </div>


    <script id="server_api">
        let timer
        // --- Save / Load Logic  ---
        const APP_FOLDER = "apps/space_type_generator/presets";

window.saveSettings = async () => {
    const name = document.getElementById('settingsName').value || 'untitled_settings';
    
    const fullPath = window.location.pathname;
    //get filename
    let filename = fullPath.substring(fullPath.lastIndexOf('/') + 1);
    // Remove the file extension
    filename = filename.substring(0, filename.lastIndexOf('.')) || filename
    
    const data = getSketchSettings(filename);

    try {
        // Updated Endpoint: /api/file/save
        const response = await fetch('/api/file/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                folder: APP_FOLDER,
                filename: name, 
                data: data 
            })
        });
        const res = await response.json();
        if(res.success) {
            alert("Settings saved!");
            refreshLoadList();
        } else {
            alert("Error: " + res.error);
        }
    } catch(e) {
        alert("Server Error during Save");
    }
};

window.loadSettings = async () => {
    const select = document.getElementById('loadSelect');
    const filename = select.value;
    if(!filename) return;

    try {
        // Updated Endpoint: /api/file/get with query params
        const response = await fetch(`/api/file/get?folder=${APP_FOLDER}&filename=${filename}`);
        if(!response.ok) throw new Error("File not found");
        
        const json = await response.json();
        
        //do something with returned file
        setSketchSettings(json);

        alert("Settings loaded");
    } catch(e) {
        console.error(e);
        alert("Error loading settings");
    }
};

async function refreshLoadList() {
    try {
        // Updated Endpoint: /api/file/list with query param
        const response = await fetch(`/api/file/list?folder=${APP_FOLDER}`);
        const files = await response.json();
        const select = document.getElementById('loadSelect');
        if (select) {
            select.innerHTML = '';
            files.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f;
                opt.innerText = f;
                select.appendChild(opt);
            });
        }
    } catch(e) { console.error("Could not fetch list", e); }
}

refreshLoadList();

function getSketchSettings(filename){
    const settings = {
        "filename" : filename,
        "typeX" : typeXSlider.value(),
        "typeY" : typeYSlider.value(),
        "typeStroke" : typeStrokeSlider.value(),
        "tracking" : trackingSlider.value(),
        "ribbonCount" : ribbonCountSlider.value(),
        "ribbonSpaceX" : ribbonSpaceXSlider.value(),
        "ribbonSpaceY" : ribbonSpaceYSlider.value(),
        "ribbonSize" : ribbonSizeSlider.value(),
        "ribbonOffset" : ribbonOffsetSlider.value(),
        "yWave" : yWaveSlider.value(),
        "speed" : speedSlider.value(),
        "offset" : offsetSlider.value(),
        "slope" : slopeSlider.value(),

        "inp1color" : inp1.value(),
        "inp2color" : inp2.value(),
        "inp3color" : inp3.value(),
        "inp4color" : inp4.value(),
        "inp5color" : inp5.value(),
        "inp1check" : inp1check.checked(),
        "inp2check" : inp2check.checked(),
        "inp3check" : inp3check.checked(),
        "inp4check" : inp4check.checked(),
        "inp5check" : inp5check.checked(),

        "text" : inp.value(),

        "inpNumber" : inpNumber,
        "bkgdColor" : bkgdColorPicker.value()
    }
    return settings
}

function setSketchSettings(json){
        typeXSlider.value(json.typeX);
        typeYSlider.value(json.typeY);
        typeStrokeSlider.value(json.typeStroke);
        trackingSlider.value(json.tracking);
        ribbonCountSlider.value(json.ribbonCount);
        ribbonSpaceXSlider.value(json.ribbonSpaceX);
        ribbonSpaceYSlider.value(json.ribbonSpaceY);
        ribbonSizeSlider.value(json.ribbonSize);
        ribbonOffsetSlider.value(json.ribbonOffset);
        yWaveSlider.value(json.yWave);
        speedSlider.value(json.speed);
        offsetSlider.value(json.offset);
        slopeSlider.value(json.slope);

        inp1.value(json.inp1color);
        inp2.value(json.inp2color);
        inp3.value(json.inp3color);
        inp4.value(json.inp4color);
        inp5.value(json.inp5color);
        inp1check.checked(json.inp1check);
        inp2check.checked(json.inp2check);
        inp3check.checked(json.inp3check);
        inp4check.checked(json.inp4check);
        inp5check.checked(json.inp5check);

        inp.value(json.text);

        inpNumber = json.inpNumber;
        bkgdColorPicker.value(json.bkgdColor)
}

    </script>

    <script>
      function myFunction() {
        alert(
          "SPACE TYPE GENERATOR\n_v.stripes 1.0\nDesign and coding by KielM.com\nThanks for using! Let me know what you make.\nkiel.d.m@gmail.com"
        );
      }
    </script>
  </body>
</html>
